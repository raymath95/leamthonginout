<!DOCTYPE html>
<html lang="th">

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Security Headers -->
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self' https:; script-src 'self' 'unsafe-inline' https://ajax.googleapis.com https://cdn.jsdelivr.net https://static.line-scdn.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://semicon.github.io; font-src 'self' https://semicon.github.io; img-src 'self' https: data:; connect-src 'self' https:;">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">

  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏´‡∏•‡∏°‡∏ó‡∏≠‡∏á‡∏Å‡∏¥‡∏à‡πÄ‡∏Å‡∏©‡∏ï‡∏£</title>

  <!-- CSS Frameworks -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css"
    rel="stylesheet" />

  <!-- LIFF SDK (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á UserID) -->
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- Fonts & Style -->
  <style>
    /* Hide Google Apps Script Banner */
    body>div[style*="background-color: #f4f4f4"],
    body>div[style*="background-color"] {
      display: none !important;
    }

    @font-face {
      font-family: 'Digital dream Fat';
      src: url('https://semicon.github.io/fonts/DigitaldreamFat.woff2') format('woff2'),
        url('https://semicon.github.io/fonts/DigitaldreamFat.woff') format('woff');
      font-weight: normal;
      font-style: normal;
      font-display: swap;
    }

    :root {
      --primary-color: #28a745;
      --secondary-color: #f1c40f;
      --dark-color: #2c3e50;
      --border-radius: 8px;
      --box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'K2D', 'Kanit', sans-serif;
    }

    body {
      font-size: 1.05rem;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #a4f8ab;
      padding: 15px;
    }

    .site-logo {
      width: auto;
      height: 80px;
      margin-bottom: 15px;
    }

    .company-name {
      font-weight: 700;
      font-size: 1.8rem;
      margin: 0 0 15px;
      color: var(--dark-color);
    }

    .msgBg {
      background: linear-gradient(135deg, #67B26F, #4ca2cd);
      color: white;
      padding: 12px;
      border-radius: var(--border-radius);
      font-weight: 500;
    }

    .wrapper {
      background: rgba(255, 255, 255, 0.92);
      width: 100%;
      max-width: 400px;
      padding: 25px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }

    .clock-container {
      background: #f8f9fa;
      padding: 15px;
      border-radius: var(--border-radius);
      margin-bottom: 20px;
      box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .clock {
      font-family: 'Digital dream Fat';
      font-size: 2rem;
      color: #000;
      letter-spacing: 3px;
      background: linear-gradient(to bottom, #e9ecef, #dee2e6);
      padding: 10px 8px;
      border: 2px solid #adb5bd;
      border-radius: 5px;
      min-width: 90%;
      text-align: center;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      font-weight: 500;
      display: block;
      margin-bottom: 8px;
      color: var(--dark-color);
    }

    .form-control {
      height: 45px;
      border-radius: var(--border-radius);
    }

    .btn-action {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .btn {
      height: 45px;
      border-radius: var(--border-radius);
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      flex: 1;
    }

    .btn-clockin {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }

    .btn-clockin:hover {
      background-color: #1e7e34;
      transform: scale(1.05);
    }

    .btn-clockout {
      background-color: var(--secondary-color);
      border-color: var(--secondary-color);
      color: #212529;
    }

    }) .then(()=> {

        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡πÑ‡∏•‡∏ô‡πå ‡∏´‡∏£‡∏∑‡∏≠ ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß
        if (liff.isLoggedIn()) {
          liff.getProfile().then(profile=> {
              userLineID=profile.userId;
              console.log("LIFF Init Success. UserID:", userLineID);
            }).catch(err=> console.error('Error getting profile:', err));
        }

        else {
          // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô ‡πÉ‡∏´‡πâ‡∏™‡∏±‡πà‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô (‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô External Browser)
          liff.login();
        }

      }) .catch((err)=> {
        console.error('LIFF Initialization failed', err);
        // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á Error popup ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤) ‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà ‡πÅ‡∏°‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏•‡∏ô‡πå
      });
    }

    function loadInitialData() {
      console.log('[Frontend] Loading initial data...');

      getEmployees().then(()=> {
          const savedEmployee=localStorage.getItem('selectedEmployee');

          if (savedEmployee) {
            $('#employee').val(savedEmployee).trigger('change');
          }
        });

      $('#employee').on("change", function () {
          if (this.value) {
            localStorage.setItem('selectedEmployee', this.value);
          }

          else {
            localStorage.removeItem('selectedEmployee');
          }
        });
    }

    // ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÅ‡∏•‡πâ‡∏ß: ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡πÉ‡∏ô Apps Script ‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å ‡∏û‡∏£‡πâ‡∏≠‡∏° Timeout Protection
    function callAppsScript(functionName, ...args) {
      console.log(`[Frontend] Calling $ {
          functionName
        }

        with args:`, args);

      // ‡∏ñ‡πâ‡∏≤‡∏£‡∏±‡∏ô‡πÉ‡∏ô Apps Script ‡πÉ‡∏ä‡πâ google.script.run
      if (typeof google !=='undefined' && google.script && google.script.run) {
        console.log('[Frontend] Using google.script.run');

        return new Promise((resolve, reject)=> {
            google.script.run .withSuccessHandler(resolve) .withFailureHandler(reject) [functionName](...args);
          });
      }

      // ‡∏ñ‡πâ‡∏≤‡∏£‡∏±‡∏ô‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å ‡πÉ‡∏ä‡πâ fetch API ‡∏û‡∏£‡πâ‡∏≠‡∏° timeout
      console.log('[Frontend] Using fetch API to:', WEB_APP_URL);
      const controller=new AbortController();
      const timeoutId=setTimeout(()=> controller.abort(), 30000); // 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ timeout

      return fetch(WEB_APP_URL, {

        method: 'POST',
        redirect: 'follow',
        headers: {
          'Content-Type': 'text/plain;charset=utf-8'
        }

        ,
        body: JSON.stringify({
          functionName, args
        }),
      signal: controller.signal

    }) .then(res=> {
        clearTimeout(timeoutId);

        if ( !res.ok) {
          throw new Error(`HTTP $ {
              res.status
            }

            : $ {
              res.statusText
            }

            `);
        }

        return res.json();

      }) .then(data=> {
        console.log(`[Frontend] Response from $ {
            functionName
          }

          :`, data);
        if (data.status==='error') throw new Error(data.message);
        return data.data;

      }) .catch(err=> {
        clearTimeout(timeoutId);

        if (err.name==='AbortError') {
          console.error('Request timeout after 30 seconds');
          throw new Error('‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡∏ä‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
        }

        console.error('API Error:', err);
        throw err;
      });
    }

    // --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô ClockIn ‡∏™‡πà‡∏á userLineID ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢ ---
    async function ClockIn() {
      const employee=$('#employee').val();

      if ( !employee) {
        Swal.fire({
          icon: 'info', title: '‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô'
        });
      return;
    }

    setButtonsProcessing(true, 'in');
    let gps=null;

    try {
      gps=await getlocation();
      // ‡∏™‡πà‡∏á userLineID ‡πÄ‡∏õ‡πá‡∏ô parameter ‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà 3
      const response=await callAppsScript('clockIn', employee, gps, userLineID);
      handleBackendResponse(response, employee, '‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô');
    }

    catch (error) {
      handleError(error, 'ClockIn', ()=> ClockInRetry(employee, gps));
    }

    finally {
      setButtonsProcessing(false);
    }
    }

    async function ClockInRetry(employee, gps) {
      if ( !employee || !gps) {
        return ClockIn();
      }

      setButtonsProcessing(true, 'in');

      try {
        // ‡∏™‡πà‡∏á userLineID ‡πÄ‡∏õ‡πá‡∏ô parameter ‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà 3
        const response=await callAppsScript('clockIn', employee, gps, userLineID);
        handleBackendResponse(response, employee, '‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô');
      }

      catch (error) {
        handleError(error, 'ClockInRetry', ()=> ClockInRetry(employee, gps));
      }

      finally {
        setButtonsProcessing(false);
      }
    }

    // --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô ClockOut ‡∏™‡πà‡∏á userLineID ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢ ---
    async function ClockOut() {
      const employee=$('#employee').val();

      if ( !employee) {
        Swal.fire({
          icon: 'info', title: '‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô'
        });
      return;
    }

    setButtonsProcessing(true, 'out');
    let gps=null;

    try {
      gps=await getlocation();
      // ‡∏™‡πà‡∏á userLineID ‡πÄ‡∏õ‡πá‡∏ô parameter ‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà 3
      const response=await callAppsScript('clockOut', employee, gps, userLineID);
      handleBackendResponse(response, employee, '‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô');
    }

    catch (error) {
      handleError(error, 'ClockOut', ()=> ClockOutRetry(employee, gps));
    }

    finally {
      setButtonsProcessing(false);
    }
    }

    async function ClockOutRetry(employee, gps) {
      if ( !employee || !gps) {
        return ClockOut();
      }

      setButtonsProcessing(true, 'out');

      try {
        // ‡∏™‡πà‡∏á userLineID ‡πÄ‡∏õ‡πá‡∏ô parameter ‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà 3
        const response=await callAppsScript('clockOut', employee, gps, userLineID);
        handleBackendResponse(response, employee, '‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô');
      }

      catch (error) {
        handleError(error, 'ClockOutRetry', ()=> ClockOutRetry(employee, gps));
      }

      finally {
        setButtonsProcessing(false);
      }
    }

    function handleBackendResponse(response, employee, status) {
      const result=response[0];

      if (result[0]==='SUCCESS') {
        showPopup(employee, result[1], status, result[3]);
        $('#employee').val(null).trigger('change');
        localStorage.removeItem('selectedEmployee');
      }

      else if (result[0]==='FAILED') {
        Swal.fire({
          customClass: {
            popup: 'warning-popup'
          }

          ,
          icon: 'warning',
          title: 'üü° ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô',
          text: result[2],
          confirmButtonText: '‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß'
        });
    }

    else {

      showErrorPopup('‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö',
        `‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤: $ {
          result[2] || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'
        }

        `,
        ()=> {});
    }
    }

    function handleError(error, context, retryCallback) {
      if (error && (error.code >=1 && error.code <=3)) {
        console.error(`$ {
            context
          }

          Geolocation Error: Already handled by getlocation() popup.`);
        return;
      }

      showErrorPopup('‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß',
        '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï',
        retryCallback);

      console.error(`$ {
          context
        }

        Error:`, error);
    }

    function showErrorPopup(title, text, retryCallback) {
      Swal.fire({

        icon: 'error',
        title: title,
        text: text,
        confirmButtonText: '‡∏õ‡∏¥‡∏î',
        showCancelButton: true,
        cancelButtonText: '‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
        cancelButtonColor: '#28a745',
      }).then((result)=> {
        if (result.dismiss===Swal.DismissReason.cancel) {
          setTimeout(()=> {
              if (typeof retryCallback==='function') {
                retryCallback();
              }
            }

            , 500);
        }
      });
    }

    async function getEmployees() {
      console.log('[Frontend] getEmployees called');
      showLoading(true);

      try {
        const data=await callAppsScript('getEmployees');
        console.log('[Frontend] Received employee data:', data);
        const safeData=Array.isArray(data) ? data: [];
        console.log('[Frontend] Safe data length:', safeData.length);
        updateEmployeeList(safeData);
      }

      catch (error) {
        console.error('[Frontend] Error fetching employees:', error);
        showErrorPopup('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', '‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', getEmployees);
      }

      finally {
        showLoading(false);
      }
    }

    function updateEmployeeList(employees) {
      console.log('[Frontend] updateEmployeeList called with:', employees);
      const employeeSelect=$("#employee");
      employeeSelect.find('option:not(:first)').remove();

      if (Array.isArray(employees) && employees.length > 0) {
        console.log('[Frontend] Adding', employees.length, 'employees to dropdown');

        employees.forEach(item=> {
            if (item[0] && item[0].trim() !=='') {
              console.log('[Frontend] Adding employee:', item[0]);
              employeeSelect.append(new Option(item[0].trim(), item[0].trim()));
            }
          });
        console.log('[Frontend] Employee list updated successfully');
      }

      else {
        console.log('[Frontend] No employees found or empty array');
        showNotification('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö');
      }
    }

    function getlocation() {
      return new Promise((resolve, reject)=> {
          if ( !navigator.geolocation) {
            return reject({
              code: 4, message: "‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Geolocation"
            });
        }

        navigator.geolocation.getCurrentPosition((position)=> resolve([position.coords.latitude, position.coords.longitude]),
          (err)=> reject(err),
          {
          enableHighAccuracy: true, timeout: 15000, maximumAge: 0
        });

    }).catch(err=> {
        let title, htmlContent;
        const isLineBrowser=navigator.userAgent.toLowerCase().includes("line");

        switch (err.code) {
          case 1: title="‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á"; htmlContent=isLineBrowser ? `<div style="text-align: left;" > <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏ô LINE ‡πÇ‡∏î‡∏¢‡πÑ‡∏õ‡∏ó‡∏µ‡πà:</p> <ol> <li>"‡∏à‡∏∏‡∏î‡∏™‡∏≤‡∏°‡∏à‡∏∏‡∏î"(‚ãÆ) ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏•‡πà‡∏≤‡∏á</li> <li>"‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå" > "‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" </li> <li>‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞ "‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå" </li> <li>‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà</li> </ol> <p class="mt-2" >‡∏´‡∏£‡∏∑‡∏≠: ‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏≠‡∏∑‡πà‡∏ô</p> </div>` : `<div style="text-align: left;" > <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå:</p> <ol> <li>‡πÅ‡∏ï‡∏∞ üîí ‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</li> <li>"‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≠‡∏á‡πÄ‡∏ß‡πá‡∏ö" > "‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á" > "‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï" </li> </ol> </div>`; break;
          case 2: title="‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ"; htmlContent="‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì GPS ‡∏≠‡πà‡∏≠‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏•‡πà‡∏á";
          break;
          case 3: title="‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á"; htmlContent="‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì GPS"; break;
          default: title="‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á"; htmlContent=`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á`;
        }

        Swal.fire({
          icon: 'warning', title: `‚ö†Ô∏è $ {
            title
          }

          `, html: htmlContent, confirmButtonText: '‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß',
          confirmButtonColor: '#d33'
        });
      throw err;
    });
    }

    function showTime() {
      const date=new Date();

      const time=date.toLocaleTimeString('th-TH', {
        hour12: false
      });
    $('#MyClockDisplay').text(time);
    setTimeout(showTime, 1000);
    }

    function setButtonsProcessing(isProcessing, actionType) {
      const btnIn=$('.btn-clockin'),
      btnOut=$('.btn-clockout');
      btnIn.add(btnOut).prop('disabled', isProcessing);

      if (isProcessing) {
        const btn=actionType==='in' ? btnIn: btnOut;
        btn.html('<span class="spinner-border spinner-border-sm me-2"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');
      }

      else {
        btnIn.html('üü¢ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô');
        btnOut.html('üî¥ ‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô');
      }
    }

    function showLoading(show) {
      $('#message').html(show ? '<span class="spinner-border spinner-border-sm me-2"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...' : '‚òÄÔ∏è ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç') .toggleClass('alert-info', show).toggleClass('msgBg', !show);
    }

    function showNotification(message) {
      $('#message').text(message).removeClass('msgBg').addClass('alert-info');
    }

    function clearForm() {
      setTimeout(()=> {
          showLoading(false);
        }

        , 2000);
    }

    function escapeHtml(unsafe) {
      return unsafe .replace(/&/g, "&amp;") .replace(/</g, "&lt;") .replace(/>/g, "&gt;") .replace(/"/g, " &quot; ")
 .replace(/'/g, "&#039;");
 popup: 'warning-popup'
        }

        ,
        icon: 'warning',
        title: 'üü° ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô',
        text: result[2],
        confirmButtonText: '‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß'
      });
    }

    else {

      showErrorPopup('‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö',
        `‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤: $ {
          result[2] || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'
        }

        `,
        ()=> {});
    }
    }

    function handleError(error, context, retryCallback) {
      if (error && (error.code >=1 && error.code <=3)) {
        console.error(`$ {
            context
          }

          Geolocation Error: Already handled by getlocation() popup.`);
        return;
      }

      showErrorPopup('‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß',
        '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï',
        retryCallback);

      console.error(`$ {
          context
        }

        Error:`, error);
    }

    function showErrorPopup(title, text, retryCallback) {
      Swal.fire({

        icon: 'error',
        title: title,
        text: text,
        confirmButtonText: '‡∏õ‡∏¥‡∏î',
        showCancelButton: true,
        cancelButtonText: '‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
        cancelButtonColor: '#28a745',
      }).then((result)=> {
        if (result.dismiss===Swal.DismissReason.cancel) {
          setTimeout(()=> {
              if (typeof retryCallback==='function') {
                retryCallback();
              }
            }

            , 500);
        }
      });
    }

    async function getEmployees() {
      console.log('[Frontend] getEmployees called');
      showLoading(true);

      try {
        const data=await callAppsScript('getEmployees');
        console.log('[Frontend] Received employee data:', data);
        const safeData=Array.isArray(data) ? data: [];
        console.log('[Frontend] Safe data length:', safeData.length);
        updateEmployeeList(safeData);
      }

      catch (error) {
        console.error('[Frontend] Error fetching employees:', error);
        showErrorPopup('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', '‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', getEmployees);
      }

      finally {
        showLoading(false);
      }
    }

    function updateEmployeeList(employees) {
      console.log('[Frontend] updateEmployeeList called with:', employees);
      const employeeSelect=$("#employee");
      employeeSelect.find('option:not(:first)').remove();

      if (Array.isArray(employees) && employees.length > 0) {
        console.log('[Frontend] Adding', employees.length, 'employees to dropdown');

        employees.forEach(item=> {
            if (item[0] && item[0].trim() !=='') {
              console.log('[Frontend] Adding employee:', item[0]);
              employeeSelect.append(new Option(item[0].trim(), item[0].trim()));
            }
          });
        console.log('[Frontend] Employee list updated successfully');
      }

      else {
        console.log('[Frontend] No employees found or empty array');
        showNotification('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö');
      }
    }

    function getlocation() {
      return new Promise((resolve, reject)=> {
          if ( !navigator.geolocation) {
            return reject({
              code: 4, message: "‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Geolocation"
            });
        }

        navigator.geolocation.getCurrentPosition((position)=> resolve([position.coords.latitude, position.coords.longitude]),
          (err)=> reject(err),
          {
          enableHighAccuracy: true, timeout: 15000, maximumAge: 0
        });

    }).catch(err=> {
        let title, htmlContent;
        const isLineBrowser=navigator.userAgent.toLowerCase().includes("line");

        switch (err.code) {
          case 1: title="‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á"; htmlContent=isLineBrowser ? `<div style="text-align: left;" > <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏ô LINE ‡πÇ‡∏î‡∏¢‡πÑ‡∏õ‡∏ó‡∏µ‡πà:</p> <ol> <li>"‡∏à‡∏∏‡∏î‡∏™‡∏≤‡∏°‡∏à‡∏∏‡∏î"(‚ãÆ) ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏•‡πà‡∏≤‡∏á</li> <li>"‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå" > "‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" </li> <li>‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞ "‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå" </li> <li>‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà</li> </ol> <p class="mt-2" >‡∏´‡∏£‡∏∑‡∏≠: ‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏≠‡∏∑‡πà‡∏ô</p> </div>` : `<div style="text-align: left;" > <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå:</p> <ol> <li>‡πÅ‡∏ï‡∏∞ üîí ‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</li> <li>"‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≠‡∏á‡πÄ‡∏ß‡πá‡∏ö" > "‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á" > "‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï" </li> </ol> </div>`; break;
          case 2: title="‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ"; htmlContent="‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì GPS ‡∏≠‡πà‡∏≠‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏•‡πà‡∏á";
          break;
          case 3: title="‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á"; htmlContent="‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì GPS"; break;
          default: title="‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á"; htmlContent=`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á`;
        }

        Swal.fire({
          icon: 'warning', title: `‚ö†Ô∏è $ {
            title
          }

          `, html: htmlContent, confirmButtonText: '‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß',
          confirmButtonColor: '#d33'
        });
      throw err;
    });
    }

    function showTime() {
      const date=new Date();

      const time=date.toLocaleTimeString('th-TH', {
        hour12: false
      });
    $('#MyClockDisplay').text(time);
    setTimeout(showTime, 1000);
    }

    function setButtonsProcessing(isProcessing, actionType) {
      const btnIn=$('.btn-clockin'),
      btnOut=$('.btn-clockout');
      btnIn.add(btnOut).prop('disabled', isProcessing);

      if (isProcessing) {
        const btn=actionType==='in' ? btnIn: btnOut;
        btn.html('<span class="spinner-border spinner-border-sm me-2"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');
      }

      else {
        btnIn.html('üü¢ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô');
        btnOut.html('üî¥ ‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô');
      }
    }

    function showLoading(show) {
      $('#message').html(show ? '<span class="spinner-border spinner-border-sm me-2"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...' : '‚òÄÔ∏è ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç') .toggleClass('alert-info', show).toggleClass('msgBg', !show);
    }

    function showNotification(message) {
      $('#message').text(message).removeClass('msgBg').addClass('alert-info');
    }

    function clearForm() {
      setTimeout(()=> {
          showLoading(false);
        }

        , 2000);
    }

    function escapeHtml(unsafe) {
      return unsafe .replace(/&/g, "&amp;") .replace(/</g, "&lt;") .replace(/>/g, "&gt;") .replace(/"/g, " &quot; ")
 .replace(/'/g, "&#039;");

        }

        function showPopup(employee, time, status, location) {
          const safeEmployee=escapeHtml(employee);
          const safeStatus=escapeHtml(status);
          const safeLocation=escapeHtml(location);

          Swal.fire({

            icon: 'success',
            title: '‚úîÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢',
            html: ` <div style="text-align: left; word-break: break-word;" > <p><strong>üë§ ‡∏ä‡∏∑‡πà‡∏≠:</strong> $ {
              safeEmployee
            }

            </p> <p><strong>‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤:</strong> $ {
              time.replace('<br>', ' ')
            }

            </p> <p><strong>üìã ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> $ {
              safeStatus
            }

            </p> <p><strong>üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:</strong> $ {
              safeLocation
            }

            </p> </div> `,
            confirmButtonText: '‡∏õ‡∏¥‡∏î',
            confirmButtonColor: '#28a745'
          });
      }

      else {
        Swal.fire({
          icon: 'error',
          title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
          text: response ? response.message : '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå'
        });
    }
    }

    function handleError(error, context, retryCallback) {
      console.error(`Error in $ {
          context
        }

        :`, error);
      let errorMsg=error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏';

      if (errorMsg.includes('‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡∏ä‡πâ‡∏≤')) {
        Swal.fire({
          icon: 'warning',
          title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà...',
          text: '‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡∏ä‡πâ‡∏≤ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
          timer: 2000,
          showConfirmButton: false

        }).then(()=> {
          if (retryCallback) retryCallback();
        });
      return;
    }

    Swal.fire({
      icon: 'error',
      title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
      text: errorMsg
    });
    }

    function setButtonsProcessing(isProcessing, type=null) {
      const btnIn=$('.btn-clockin');
      const btnOut=$('.btn-clockout');

      if (isProcessing) {
        btnIn.prop('disabled', true);
        btnOut.prop('disabled', true);
        if (type==='in') btnIn.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');
        if (type==='out') btnOut.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');
      }

      else {
        btnIn.prop('disabled', false).html('üü¢ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô');
        btnOut.prop('disabled', false).html('ÔøΩ ‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô');
      }
    }

    function showTime() {
      const date=new Date();
      let h=date.getHours();
      let m=date.getMinutes();
      let s=date.getSeconds();
      let session="AM";

      if (h==0) {
        h=12;
      }

      if (h > 12) {
        h=h - 12; session="PM";
      }

      h=(h < 10) ? "0" + h : h;
      m=(m < 10) ? "0" + m : m;
      s=(s < 10) ? "0" + s : s;

      const time=h + ":" + m + ":" + s + " " + session;
      const clockDisplay=document.getElementById("MyClockDisplay");

      if (clockDisplay) {
        clockDisplay.innerText=time;
        clockDisplay.textContent=time;
      }

      setTimeout(showTime, 1000);
    }

    function getlocation() {
      return new Promise((resolve, reject)=> {
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((position)=> {
                resolve(`$ {
                    position.coords.latitude
                  }

                  , $ {
                    position.coords.longitude
                  }

                  `);
              }

              ,
              (error)=> {
                console.error('Geolocation error:', error);
                reject(new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á GPS ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS'));
              }

              ,
              {
              enableHighAccuracy: true, timeout: 10000, maximumAge: 0
            });
        }

        else {
          reject(new Error('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Geolocation'));
        }
      });
    }

    function escapeHtml(text) {
      if ( !text) return text;
      return String(text) .replace(/&/g, "&amp;") .replace(/</g, "&lt;") .replace(/>/g, "&gt;") .replace(/"/g, " &quot; ")
 .replace(/'/g, "&#039;");

        }

        function getEmployees() {
          return callAppsScript('getEmployees') .then(data=> {
              const select=$('#employee');
              select.empty();
              select.append('<option value="" disabled selected>‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô...</option>');

              if (Array.isArray(data)) {
                data.forEach(emp=> {
                    select.append(`<option value="${emp}" >$ {
                        emp
                      }

                      </option>`);
                  });
              }

            }) .catch(err=> {
              console.error('Failed to load employees:', err);

              Swal.fire({
                icon: 'error', title: '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ'
              });
          });
      }

      </script> </body> </html>