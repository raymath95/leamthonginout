<!DOCTYPE html>
<html lang="th">

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Security Headers -->
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self' https:; script-src 'self' 'unsafe-inline' https://ajax.googleapis.com https://cdn.jsdelivr.net https://static.line-scdn.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://semicon.github.io; font-src 'self' https://semicon.github.io; img-src 'self' https: data:; connect-src 'self' https:;">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">

  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏´‡∏•‡∏°‡∏ó‡∏≠‡∏á‡∏Å‡∏¥‡∏à‡πÄ‡∏Å‡∏©‡∏ï‡∏£</title>

  <!-- CSS Frameworks -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css"
    rel="stylesheet" />

  <!-- LIFF SDK (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á UserID) -->
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- Fonts & Style -->
  <style>
    /* Hide Google Apps Script Banner */
    body>div[style*="background-color: #f4f4f4"],
    body>div[style*="background-color"] {
      display: none !important;
    }

    @font-face {
      font-family: 'Digital dream Fat';
      src: url('https://semicon.github.io/fonts/DigitaldreamFat.woff2') format('woff2'),
        url('https://semicon.github.io/fonts/DigitaldreamFat.woff') format('woff');
      font-weight: normal;
      font-style: normal;
      font-display: swap;
    }

    :root {
      --primary-color: #28a745;
      --secondary-color: #f1c40f;
      --dark-color: #2c3e50;
      --border-radius: 8px;
      --box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'K2D', 'Kanit', sans-serif;
    }

    body {
      font-size: 1.05rem;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #a4f8ab;
      padding: 15px;
    }

    .site-logo {
      width: auto;
      height: 80px;
      margin-bottom: 15px;
    }

    .company-name {
      font-weight: 700;
      font-size: 1.8rem;
      margin: 0 0 15px;
      color: var(--dark-color);
    }

    .msgBg {
      background: linear-gradient(135deg, #67B26F, #4ca2cd);
      color: white;
      padding: 12px;
      border-radius: var(--border-radius);
      font-weight: 500;
    }

    .wrapper {
      background: rgba(255, 255, 255, 0.92);
      width: 100%;
      max-width: 400px;
      padding: 25px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }

    .clock-container {
      background: #f8f9fa;
      padding: 15px;
      border-radius: var(--border-radius);
      margin-bottom: 20px;
      box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .clock {
      font-family: 'Digital dream Fat';
      font-size: 2rem;
      color: #000;
      letter-spacing: 3px;
      background: linear-gradient(to bottom, #e9ecef, #dee2e6);
      padding: 10px 8px;
      border: 2px solid #adb5bd;
      border-radius: 5px;
      min-width: 90%;
      text-align: center;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      font-weight: 500;
      display: block;
      margin-bottom: 8px;
      color: var(--dark-color);
    }

    .form-control {
      height: 45px;
      border-radius: var(--border-radius);
    }

    .btn-action {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .btn {
      height: 45px;
      border-radius: var(--border-radius);
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      flex: 1;
    }

    .btn-clockin {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }

    .btn-clockin:hover {
      background-color: #1e7e34;
      transform: scale(1.05);
    }

    .btn-clockout {
      background-color: var(--secondary-color);
      border-color: var(--secondary-color);
      color: #212529;
    }

    .btn-clockout:hover {
      background-color: #d39e00;
      transform: scale(1.05);
    }

    .alert {
      padding: 15px;
      border-radius: var(--border-radius);
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .alert-info {
      background-color: #d1ecf1;
      border-color: #bee5eb;
      color: #0c5460;
    }

    .swal2-popup.warning-popup {
      background-color: #fffacd;
    }
  </style>
</head>
<!DOCTYPE html>
<html lang="th">

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Security Headers -->
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self' https:; script-src 'self' 'unsafe-inline' https://ajax.googleapis.com https://cdn.jsdelivr.net https://static.line-scdn.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://semicon.github.io; font-src 'self' https://semicon.github.io; img-src 'self' https: data:; connect-src 'self' https:;">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">

  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏´‡∏•‡∏°‡∏ó‡∏≠‡∏á‡∏Å‡∏¥‡∏à‡πÄ‡∏Å‡∏©‡∏ï‡∏£</title>

  <!-- CSS Frameworks -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css"
    rel="stylesheet" />

  <!-- LIFF SDK (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á UserID) -->
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- Fonts & Style -->
  <style>
    /* Hide Google Apps Script Banner */
    body>div[style*="background-color: #f4f4f4"],
    body>div[style*="background-color"] {
      display: none !important;
    }

    @font-face {
      font-family: 'Digital dream Fat';
      src: url('https://semicon.github.io/fonts/DigitaldreamFat.woff2') format('woff2'),
        url('https://semicon.github.io/fonts/DigitaldreamFat.woff') format('woff');
      font-weight: normal;
      font-style: normal;
      font-display: swap;
    }

    :root {
      --primary-color: #28a745;
      --secondary-color: #f1c40f;
      --dark-color: #2c3e50;
      --border-radius: 8px;
      --box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'K2D', 'Kanit', sans-serif;
    }

    body {
      font-size: 1.05rem;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #a4f8ab;
      padding: 15px;
    }

    .site-logo {
      width: auto;
      height: 80px;
      margin-bottom: 15px;
    }

    .company-name {
      font-weight: 700;
      font-size: 1.8rem;
      margin: 0 0 15px;
      color: var(--dark-color);
    }

    .msgBg {
      background: linear-gradient(135deg, #67B26F, #4ca2cd);
      color: white;
      padding: 12px;
      border-radius: var(--border-radius);
      font-weight: 500;
    }

    .wrapper {
      background: rgba(255, 255, 255, 0.92);
      width: 100%;
      max-width: 400px;
      padding: 25px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }

    .clock-container {
      background: #f8f9fa;
      padding: 15px;
      border-radius: var(--border-radius);
      margin-bottom: 20px;
      box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .clock {
      font-family: 'Digital dream Fat';
      font-size: 2rem;
      color: #000;
      letter-spacing: 3px;
      background: linear-gradient(to bottom, #e9ecef, #dee2e6);
      padding: 10px 8px;
      border: 2px solid #adb5bd;
      border-radius: 5px;
      min-width: 90%;
      text-align: center;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      font-weight: 500;
      display: block;
      margin-bottom: 8px;
      color: var(--dark-color);
    }

    .form-control {
      height: 45px;
      border-radius: var(--border-radius);
    }

    .btn-action {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .btn {
      height: 45px;
      border-radius: var(--border-radius);
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      flex: 1;
    }

    .btn-clockin {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }

    .btn-clockin:hover {
      background-color: #1e7e34;
      transform: scale(1.05);
    }

    .btn-clockout {
      background-color: var(--secondary-color);
      border-color: var(--secondary-color);
      color: #212529;
    }

    .btn-clockout:hover {
      background-color: #d39e00;
      transform: scale(1.05);
    }

    .alert {
      padding: 15px;
      border-radius: var(--border-radius);
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .alert-info {
      background-color: #d1ecf1;
      border-color: #bee5eb;
      color: #0c5460;
    }

    .swal2-popup.warning-popup {
      background-color: #fffacd;
    }
  </style>
</head>

<body>
  <div class="wrapper">
    <div class="text-center">
      <img src="https://img5.pic.in.th/file/secure-sv1/7088b986100a839eee3df494134be747.png" alt="‡πÅ‡∏´‡∏•‡∏°‡∏ó‡∏≠‡∏á‡∏Å‡∏¥‡∏à‡πÄ‡∏Å‡∏©‡∏ï‡∏£"
        class="site-logo">
      <h1 class="company-name">‡πÅ‡∏´‡∏•‡∏°‡∏ó‡∏≠‡∏á‡∏Å‡∏¥‡∏à‡πÄ‡∏Å‡∏©‡∏ï‡∏£</h1>
    </div>
    <div class="clock-container text-center">
      <div id="MyClockDisplay" class="clock"></div>
    </div>
    <form id="myForm">
      <div class="form-group">
        <label for="employee">üë§ ‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
        <select class="form-control select2" id="employee">
          <option value="" disabled selected>‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô...</option>
        </select>
      </div>
      <div class="btn-action">
        <button type="button" class="btn btn-clockin" onclick="ClockIn()">üü¢ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</button>
        <button type="button" class="btn btn-clockout" onclick="ClockOut()">üî¥ ‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô</button>
      </div>
      <div class="form-group">
        <div class="alert msgBg" role="alert" id="message"></div>
      </div>
    </form>
  </div>

  <!-- Debug Log Section -->
  <div id="debug-log"
    style="margin-top: 20px; padding: 10px; background: #333; color: #0f0; font-family: monospace; font-size: 12px; border-radius: 5px; max-height: 200px; overflow-y: auto; display: none;">
    <strong>Debug Log:</strong><br>
  </div>

  <!-- Scripts -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    // --- Visual Logger ---
    function logToScreen(msg, type = 'info') {
      const logDiv = document.getElementById('debug-log');
      if (logDiv) {
        logDiv.style.display = 'block';
        const color = type === 'error' ? '#ff6b6b' : '#0f0';
        logDiv.innerHTML += `<div style="color: ${color}; border-bottom: 1px solid #444; padding: 2px;">${new Date().toLocaleTimeString()} - ${msg}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
      }
      // ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á log ‡∏•‡∏á console ‡∏î‡πâ‡∏ß‡∏¢
      if (type === 'error') console.originalError ? console.originalError(msg) : console.error(msg);
      else console.originalLog ? console.originalLog(msg) : console.log(msg);
    }

    // Override console.log & error
    console.originalLog = console.log;
    console.originalError = console.error;
    console.log = function (msg) { logToScreen(msg, 'info'); };
    console.error = function (msg) { logToScreen(msg, 'error'); };

    // --- Global Variable ‡πÄ‡∏Å‡πá‡∏ö UserID ‡∏Ç‡∏≠‡∏á‡πÑ‡∏•‡∏ô‡πå ---
    var userLineID = "";

    // ‡πÉ‡∏™‡πà LIFF ID ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
    const MY_LIFF_ID = "2008550547-YqeDarAE";

    // ‚ö†Ô∏è ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ï‡πâ‡∏≠‡∏á Deploy code.gs ‡πÄ‡∏õ‡πá‡∏ô Web App ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏≠‡∏≤ URL ‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzQETxqoLA6CfSXU0AvEnUjGdqZP2Huq6ueuYiJoXcnsbFCvLd2MRtbrEEJOZMdIFNN/exec";

    $(document).ready(function () {
      console.log('[Frontend] Page loaded');
      $('#message').html('‚òÄÔ∏è ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç');
      $('.select2').select2({ theme: 'bootstrap-5', placeholder: '‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...', allowClear: true });
      showTime();
      loadInitialData();

      // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô LIFF
      initializeLiff();
    });

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö LIFF ---
    function initializeLiff() {
      liff.init({ liffId: MY_LIFF_ID })
        .then(() => {
          // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡πÑ‡∏•‡∏ô‡πå ‡∏´‡∏£‡∏∑‡∏≠ ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß
          if (liff.isLoggedIn()) {
            liff.getProfile().then(profile => {
              userLineID = profile.userId;
              console.log("LIFF Init Success. UserID:", userLineID);
            }).catch(err => console.error('Error getting profile:', err));
          } else {
            // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô ‡πÉ‡∏´‡πâ‡∏™‡∏±‡πà‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô (‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô External Browser)
            liff.login();
          }
        })
        .catch((err) => {
          console.error('LIFF Initialization failed', err);
          // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á Error popup ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤) ‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà ‡πÅ‡∏°‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏•‡∏ô‡πå
        });
    }

    function loadInitialData() {
      console.log('[Frontend] Loading initial data...');
      getEmployees().then(() => {
        const savedEmployee = localStorage.getItem('selectedEmployee');
        if (savedEmployee) {
          $('#employee').val(savedEmployee).trigger('change');
        }
      });
      $('#employee').on("change", function () {
        if (this.value) {
          localStorage.setItem('selectedEmployee', this.value);
        } else {
          localStorage.removeItem('selectedEmployee');
        }
      });
    }

    // ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÅ‡∏•‡πâ‡∏ß: ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡πÉ‡∏ô Apps Script ‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å ‡∏û‡∏£‡πâ‡∏≠‡∏° Timeout Protection
    function callAppsScript(functionName, ...args) {
      console.log(`[Frontend] Calling ${functionName} with args:`, args);

      // ‡∏ñ‡πâ‡∏≤‡∏£‡∏±‡∏ô‡πÉ‡∏ô Apps Script ‡πÉ‡∏ä‡πâ google.script.run
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        console.log('[Frontend] Using google.script.run');
        return new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
          [functionName](...args);
        });
      }

      // ‡∏ñ‡πâ‡∏≤‡∏£‡∏±‡∏ô‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å ‡πÉ‡∏ä‡πâ fetch API ‡∏û‡∏£‡πâ‡∏≠‡∏° timeout
      console.log('[Frontend] Using fetch API to:', WEB_APP_URL);
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ timeout

      return fetch(WEB_APP_URL, {
        method: 'POST',
        redirect: 'follow',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({ functionName, args }),
        signal: controller.signal
      })
        .then(res => {
          clearTimeout(timeoutId);
          if (!res.ok) {
            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
          }
          return res.json();
        })
        .then(data => {
          console.log(`[Frontend] Response from ${functionName}:`, data);
          if (data.status === 'error') throw new Error(data.message);
          return data.data;
        })
        .catch(err => {
          clearTimeout(timeoutId);
          if (err.name === 'AbortError') {
            console.error('Request timeout after 30 seconds');
            throw new Error('‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡∏ä‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
          }
          console.error('API Error:', err);
          throw err;
        });
    }

    // --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô ClockIn ‡∏™‡πà‡∏á userLineID ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢ ---
    async function ClockIn() {
      const employee = $('#employee').val();
      if (!employee) {
        Swal.fire({ icon: 'info', title: '‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô' });
        return;
      }
      setButtonsProcessing(true, 'in');
      let gps = null;
      try {
        gps = await getlocation();
        // ‡∏™‡πà‡∏á userLineID ‡πÄ‡∏õ‡πá‡∏ô parameter ‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà 3
        const response = await callAppsScript('clockIn', employee, gps, userLineID);
        handleBackendResponse(response, employee, '‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô');
      } catch (error) {
        handleError(error, 'ClockIn', () => ClockInRetry(employee, gps));
      } finally {
        setButtonsProcessing(false);
      }
    }

    async function ClockInRetry(employee, gps) {
      if (!employee || !gps) {
        return ClockIn();
      }
      setButtonsProcessing(true, 'in');
      try {
        // ‡∏™‡πà‡∏á userLineID ‡πÄ‡∏õ‡πá‡∏ô parameter ‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà 3
        const response = await callAppsScript('clockIn', employee, gps, userLineID);
        handleBackendResponse(response, employee, '‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô');
      } catch (error) {
        handleError(error, 'ClockInRetry', () => ClockInRetry(employee, gps));
      } finally {
        setButtonsProcessing(false);
      }
    }

    // --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô ClockOut ‡∏™‡πà‡∏á userLineID ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢ ---
    async function ClockOut() {
      const employee = $('#employee').val();
      if (!employee) {
        Swal.fire({ icon: 'info', title: '‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô' });
        return;
      }
      setButtonsProcessing(true, 'out');
      let gps = null;
      try {
        gps = await getlocation();
        // ‡∏™‡πà‡∏á userLineID ‡πÄ‡∏õ‡πá‡∏ô parameter ‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà 3
        const response = await callAppsScript('clockOut', employee, gps, userLineID);
        handleBackendResponse(response, employee, '‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô');
      } catch (error) {
        handleError(error, 'ClockOut', () => ClockOutRetry(employee, gps));
      } finally {
        setButtonsProcessing(false);
      }
    }

    async function ClockOutRetry(employee, gps) {
      if (!employee || !gps) {
        return ClockOut();
      }
      setButtonsProcessing(true, 'out');
      try {
        // ‡∏™‡πà‡∏á userLineID ‡πÄ‡∏õ‡πá‡∏ô parameter ‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà 3
        const response = await callAppsScript('clockOut', employee, gps, userLineID);
        handleBackendResponse(response, employee, '‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô');
      } catch (error) {
        handleError(error, 'ClockOutRetry', () => ClockOutRetry(employee, gps));
      } finally {
        setButtonsProcessing(false);
      }
    }

    function handleBackendResponse(response, employee, status) {
      const result = response[0];

      if (result[0] === 'SUCCESS') {
        showPopup(employee, result[1], status, result[3]);
        $('#employee').val(null).trigger('change');
        localStorage.removeItem('selectedEmployee');
      } else if (result[0] === 'FAILED') {
        Swal.fire({
          customClass: { popup: 'warning-popup' },
          icon: 'warning',
          title: 'üü° ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô',
          text: result[2],
          confirmButtonText: '‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß'
        });
      } else {
        showErrorPopup(
          '‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö',
          `‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤: ${result[2] || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'}`,
          () => { }
        );
      }
    }

    function handleError(error, context, retryCallback) {
      if (error && (error.code >= 1 && error.code <= 3)) {
        console.error(`${context} Geolocation Error: Already handled by getlocation() popup.`);
        return;
      }

      showErrorPopup(
        '‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß',
        '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï',
        retryCallback
      );
      console.error(`${context} Error:`, error);
    }

    function showErrorPopup(title, text, retryCallback) {
      Swal.fire({
        icon: 'error',
        title: title,
        text: text,
        confirmButtonText: '‡∏õ‡∏¥‡∏î',
        showCancelButton: true,
        cancelButtonText: '‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
        cancelButtonColor: '#28a745',
      }).then((result) => {
        if (result.dismiss === Swal.DismissReason.cancel) {
          setTimeout(() => {
            if (typeof retryCallback === 'function') {
              retryCallback();
            }
          }, 500);
        }
      });
    }

    async function getEmployees() {
      console.log('[Frontend] getEmployees called');
      showLoading(true);
      try {
        const data = await callAppsScript('getEmployees');
        console.log('[Frontend] Received employee data:', data);
        const safeData = Array.isArray(data) ? data : [];
        console.log('[Frontend] Safe data length:', safeData.length);
        updateEmployeeList(safeData);
      } catch (error) {
        console.error('[Frontend] Error fetching employees:', error);
        showErrorPopup('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', '‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', getEmployees);
      } finally {
        showLoading(false);
      }
    }

    function updateEmployeeList(employees) {
      console.log('[Frontend] updateEmployeeList called with:', employees);
      const employeeSelect = $("#employee");
      employeeSelect.find('option:not(:first)').remove();
      if (Array.isArray(employees) && employees.length > 0) {
        console.log('[Frontend] Adding', employees.length, 'employees to dropdown');
        employees.forEach(item => {
          if (item[0] && item[0].trim() !== '') {
            console.log('[Frontend] Adding employee:', item[0]);
            employeeSelect.append(new Option(item[0].trim(), item[0].trim()));
          }
        });
        console.log('[Frontend] Employee list updated successfully');
      } else {
        console.log('[Frontend] No employees found or empty array');
        showNotification('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö');
      }
    }

    function getlocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          return reject({ code: 4, message: "‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Geolocation" });
        }
        navigator.geolocation.getCurrentPosition(
          (position) => resolve([position.coords.latitude, position.coords.longitude]),
          (err) => reject(err),
          { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
        );
      }).catch(err => {
        let title, htmlContent;
        const isLineBrowser = navigator.userAgent.toLowerCase().includes("line");
        switch (err.code) {
          case 1: title = "‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á"; htmlContent = isLineBrowser ? `<div style="text-align: left;">
            <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏ô LINE ‡πÇ‡∏î‡∏¢‡πÑ‡∏õ‡∏ó‡∏µ‡πà:</p>
            <ol>
              <li>"‡∏à‡∏∏‡∏î‡∏™‡∏≤‡∏°‡∏à‡∏∏‡∏î" (‚ãÆ) ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏•‡πà‡∏≤‡∏á</li>
              <li>"‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå" > "‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"</li>
              <li>‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞ "‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå"</li>
              <li>‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà</li>
            </ol>
            <p class="mt-2">‡∏´‡∏£‡∏∑‡∏≠: ‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏≠‡∏∑‡πà‡∏ô</p>
          </div>` : `<div style="text-align: left;">
            <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå:</p>
            <ol>
              <li>‡πÅ‡∏ï‡∏∞ üîí ‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</li>
              <li>"‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≠‡∏á‡πÄ‡∏ß‡πá‡∏ö" > "‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á" > "‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï"</li>
            </ol>
          </div>`; break;
          case 2: title = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ"; htmlContent = "‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì GPS ‡∏≠‡πà‡∏≠‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏•‡πà‡∏á";
            break;
          case 3: title = "‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á"; htmlContent = "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì GPS"; break;
          default: title = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á"; htmlContent = `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á`;
        }
        Swal.fire({
          icon: 'warning', title: `‚ö†Ô∏è ${title}`, html: htmlContent, confirmButtonText: '‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß',
          confirmButtonColor: '#d33'
        });
        throw err;
      });
    }

    function showTime() {
      const date = new Date();
      const time = date.toLocaleTimeString('th-TH', { hour12: false });
      $('#MyClockDisplay').text(time);
      setTimeout(showTime, 1000);
    }

    function setButtonsProcessing(isProcessing, actionType) {
      const btnIn = $('.btn-clockin'), btnOut = $('.btn-clockout');
      btnIn.add(btnOut).prop('disabled', isProcessing);
      if (isProcessing) {
        const btn = actionType === 'in' ? btnIn : btnOut;
        btn.html('<span class="spinner-border spinner-border-sm me-2"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');
      } else {
        btnIn.html('üü¢ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô');
        btnOut.html('üî¥ ‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô');
      }
    }

    function showLoading(show) {
      $('#message').html(show ? '<span class="spinner-border spinner-border-sm me-2"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...' : '‚òÄÔ∏è ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç')
        .toggleClass('alert-info', show).toggleClass('msgBg', !show);
    }

    function showNotification(message) {
      $('#message').text(message).removeClass('msgBg').addClass('alert-info');
    }

    function clearForm() {
      setTimeout(() => {
        showLoading(false);
      }, 2000);
    }

    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function showPopup(employee, time, status, location) {
      const safeEmployee = escapeHtml(employee);
      const safeStatus = escapeHtml(status);
      const safeLocation = escapeHtml(location);

      Swal.fire({
        icon: 'success', title: '‚úîÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢',
        html: `<div style="text-align: left; word-break: break-word;">
            <p><strong>üë§ ‡∏ä‡∏∑‡πà‡∏≠:</strong> ${safeEmployee}</p>
            <p><strong>‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤:</strong> ${time.replace('<br>', ' ')}</p>
            <p><strong>üìã ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> ${safeStatus}</p>
            <p><strong>üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:</strong> ${safeLocation}</p>
          </div>`,
        confirmButtonText: '‡∏õ‡∏¥‡∏î', confirmButtonColor: '#28a745'
      });
    }
  </script>
</body>

</html>